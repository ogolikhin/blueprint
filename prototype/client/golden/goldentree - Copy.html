<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <title> Blueprint HTML5 SPA Prototype - Using Golden Layout</title>
  <link rel="icon" type="image/ico" href="/blueprint.ico"/>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <!-- bower components -->
  <script type="text/javascript" src="client/bower_components/jquery/dist/jquery.min.js"></script>
  <script type="text/javascript" src="client/bower_components/golden-layout/dist/goldenlayout.min.js"></script>
  <script type="text/javascript" src="client/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

  <script type="text/javascript" src="client/bower_components/angular/angular.min.js"></script>
  <script src="client/bower_components/angular-route/angular-route.js"></script>
  <script src="client/bower_components/angular-cookies/angular-cookies.js"></script>   

  <script type="text/javascript" src="client/bower_components/angular-bootstrap/ui-bootstrap.min.js"></script>
  <script type="text/javascript" src="client/bower_components/angular-bootstrap/ui-bootstrap-tpls.min.js"></script>


  <link type="text/css" rel="stylesheet" href="client/bower_components/golden-layout/src/css/goldenlayout-base.css" />
  <link type="text/css" rel="stylesheet" href="client/bower_components/golden-layout/src/css/goldenlayout-dark-theme.css" />
  <link type="text/css" rel="stylesheet" src="client/bower_components/bootstrap/dist/css/bootstrap-theme.min.css" />
  <!-- bower -->

  <link rel="stylesheet" href="../tree/jstree/dist/themes/default/style.min.css" />

  <script src="//static.jstree.com/3.2.1/assets/jquery.address-1.6.js"></script>
  <script src="//static.jstree.com/3.2.1/assets/vakata.js"></script>
  <script src="//static.jstree.com/3.2.1/assets/dist/jstree.min.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/golden.css" />

</head>

<body>
  <link href='http://fonts.googleapis.com/css?family=Hind:400,500' rel='stylesheet' type='text/css'>

<div id="blue" style="display: block; color: white; position: absolute; top: 0px; height: 28px; width: 100%; background-color: rgb(28, 41, 92);">
              <span style="font-family: 'Hind', sans-serif; font-size: large">&nbsp;&nbsp;&nbsp;<b>blueprint Â®</b></span>
              <span style="position: fixed;right: 15px; top:6px;">Welcome Pegah Tabrizi | Home | Logout</span>

 </div>         
 <br/><br/>

<div id="wrapper">
  <div id="menuContainer">
    
<!-- Single button -->


  </div>


  <div id="layoutContainer"></div>
</div>


<template type="text/html" id="userlistTemplate">
  <ul ng-controller="userlistController" class="userlist">
    <li ng-repeat="user in users" 
        ng-click="select( user )"
        ng-class="{selected:user.isSelected}">
      {{user.name}}
    </li>
  </ul>
  <div jstree id="jstree" selected-node="selectedTreeNode" selected-path ="selectedPath" selected-node-changed="nodeChanged" style="overflow: auto;">
  </div>  
</template>

  <template type="text/html" id="userDetailTemplate">
    <div ng-controller="userdetailsController" class="userdetails">
      <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/152047/{{user.img}}" width="100" height="100" />
      <h2>{{user.name}}</h2>
      <p>{{user.street}}</p>
    </div>
</template>

<script>
var app = angular.module('userlist', ['ngCookies','ngRoute']);
app.controller('userlistController', function( $scope, $timeout, container, state ) {

    var selectedUser = {};

    $scope.users = [
      { name: 'Jackson Turner', street: '217 Tawny End', img: 'men_1.jpg' },
      { name: 'Megan Perry', street: '77 Burning Ramp', img: 'women_1.jpg' },
      { name: 'Ryan Harris', street: '12 Hazy Apple Route', img: 'men_2.jpg' },
      { name: 'Jennifer Edwards', street: '33 Maple Drive', img: 'women_2.jpg' },
      { name: 'Noah Jenkins', street: '423 Indian Pond Cape', img: 'men_3.jpg' }
    ];

    $timeout(function(){
      $scope.select( $scope.users[ state.selectedUserIndex ] );
    });

    $scope.select = function( user ) {
      selectedUser.isSelected = false;
      user.isSelected = true;
      selectedUser = user;
      container.extendState({ selectedUserIndex: $scope.users.indexOf( user ) });
      container.layoutManager.eventHub.emit( 'userSelected', user );
    };
  });

app.controller('userdetailsController', function( $scope, container, state ) {
    $scope.user = state.user || null;

    container.layoutManager.eventHub.on( 'userSelected', function( user ){
      $scope.user = user;
      container.extendState({ user: user });
      $scope.$apply();
    });
  });


//////////////////////////////////////////////////////






var AngularModuleComponent = function( container, state ) {
  var html = $( '#' + state.templateId ).html(),
    element = container.getElement();
  
  element.html( html );

  angular
    .module( state.module )
    .value( 'container', container )
    .value( 'state', state );

  angular.bootstrap( element[ 0 ], [ state.module ] );
};

var myLayout = new GoldenLayout({
  content:[{
    type: 'row',
    content: [{
      width: 20,
      title: 'Explorer',
      type: 'component',
      componentName: 'angularModule',
      componentState: {
        module: 'userlist',
        templateId: 'userlistTemplate',
        selectedUserIndex: 2
      }
      },{
      type: 'component',
      title: 'Selected User',
      componentName: 'angularModule',
      componentState: {
        module: 'userdetails',
        templateId: 'userDetailTemplate'
      }
    },{
      type: 'component',
      title: 'Selected User',
      componentName: 'angularModule',
      componentState: {
        module: 'userdetails',
        templateId: 'userDetailTemplate'
      }
    }]
  }]
} , $('#layoutContainer') );

myLayout.registerComponent( 'angularModule', AngularModuleComponent );
myLayout.init();






//////////////////////////////////////////////////////
/**
 * jstree controller/directive (in progress)
 */
app.directive('jstree', function($sce, $http, $location, $cookieStore, $timeout, $parse) {   
    return {
        restrict: 'A',
        require: '?ngModel',
        scope: {
          selectedNode: '=?',
            selectedNodeChanged: '=',
      selectedPath: '=?'
        },
        link: function(scope, element, attrs) {
          scope.selectedNode = scope.selectedNode || {};
            var treeElement = $(element);            
            var rootNodes = [];
            var selectedPath = scope.selectedPath;
            var tree = treeElement.jstree({
                'core' : {
          "animation" : 0,
          "worker" : false,
          'check_callback' : true,
                    'data' : {
                        'url' : function (node) {
              //selectedPath = $cookieStore.get('pegah'); 
              //console.log(selectedPath.search);
              var selectedPath = scope.selectedPath;
              //if (selectedPath == null) {
              //  selectedPath = $cookieStore.get('pegah');
              //}
              //console.log(selectedPath)
              var url = 'api/resources';
                            if ($location.path() === '/All' || $location.path() === '/') {
                rootNodes.push(node);
                                scope.selectedNode.showWelcome = true;
                            } else {
                                scope.selectedNode.showWelcome = false;
                            }
                            if (node.id === '#') {
                if (typeof(selectedPath.device) != "undefined") {
                  url = 'api/resources?device='+selectedPath.device;
                  if (typeof(selectedPath.packageId) != "undefined") {
                    url += "&package=" + selectedPath.packageId;
                  }                 
                  if (typeof(selectedPath.search) != "undefined") {
                    url += "&search=" + selectedPath.search;
                  }
                }
                else if (typeof(selectedPath.devtool) != "undefined") {
                  url = 'api/resources?devtool='+selectedPath.devtool;                
                  if (typeof(selectedPath.packageId) != "undefined") {
                    url += "&package=" + selectedPath.packageId;
                  }                                   
                  if (typeof(selectedPath.search) != "undefined") {
                    url += "&search=" + selectedPath.search;
                  }
                }
                else if (typeof(selectedPath.packageId) != "undefined") {
                  url = 'api/resources?package='+selectedPath.packageId;                
                  if (typeof(selectedPath.search) != "undefined") {
                    url += "&search=" + selectedPath.search;
                  }
                }               
                else if (typeof(selectedPath.search) != "undefined") {
                  url = "api/resources?search=" + selectedPath.search;
                }
                
                            } else {
                                var path = ''; 
                                for (var i = node.parents.length - 2; i >= 0 ; i--) { 
                                    var nodInfo = $("#" + node.parents[i]);
                                    var node_name = nodInfo.children("a").text();
                                    var span = node_name.indexOf(' - (');
                                    if (span > 0) {
                                        node_name = node_name.substring(0,span);
                                    }
                                    if (node_name != "")
                    path = path + node_name + '/';
                                }
                                var text = node.text;
                                var span = text.indexOf(' - (');
                                if (span > 0) {
                                    text = text.substring(0,span);
                                }
                                path = path + text;
                url = 'api/resources?path=' + path;
                if (typeof(selectedPath.device) != "undefined") {
                  url = 'api/resources?device='+selectedPath.device;
                  if (typeof(selectedPath.packageId) != "undefined") {
                    url += "&package=" + selectedPath.packageId;
                  }                                   
                  if (typeof(selectedPath.search) != "undefined") {
                    url += "&search=" + selectedPath.search;
                  }
                  url += '&path=' + path;
                }
                else if (typeof(selectedPath.devtool) != "undefined") {
                  url = 'api/resources?devtool='+selectedPath.devtool;
                  if (typeof(selectedPath.packageId) != "undefined") {
                    url += "&package=" + selectedPath.packageId;
                  }                                   
                  if (typeof(selectedPath.search) != "undefined") {
                    url += "&search=" + selectedPath.search;
                  }
                  url += '&path=' + path;
                }
                else if (typeof(selectedPath.packageId) != "undefined") {
                  url = 'api/resources?package='+selectedPath.packageId;
                  if (typeof(selectedPath.search) != "undefined") {
                    url += "&search=" + selectedPath.search;
                  }
                  url += '&path=' + path;
                }               
                else {
                  if (typeof(selectedPath.search) != "undefined") {
                    url = "api/resources?search=" + selectedPath.search+'&path=' + path;
                  }
                  else {
                    url = "api/resources?path=" + path;
                  }
                }
                                
                            }
              //show the selected node content on right hand side
              if (typeof(scrollingContent) != "undefined" && scrollingContent != null) {
                scrollingContent.jScrollPane( { autoReinitialise: true })
                .parent(".jScrollPaneContainer").css({
                  width:  '100%'
                , height: '100%'
                });
              }             
              if (typeof(scrollingContent2) != "undefined" && scrollingContent2 != null) {
                scrollingContent2.jScrollPane( { autoReinitialise: true })
                .parent(".jScrollPaneContainer").css({
                  width:  '100%'
                , height: '100%'
                });
              }
              if (typeof(node.state) != "undefined" && typeof(node.state.selected) != "undefined" && node.state.selected) {
                scope.selectedNode.waiting = true;
                var n =  node;        
                n.parentUrl = node.original.url;
                if (n.parentUrl.substring(0,1) === '/') {
                  n.parentUrl = n.parentUrl.substring(1); 
                }
                
                var nodeName = node.text;
                var span = nodeName.indexOf(' - (');
                if (span > 0) {
                  nodeName = nodeName.substring(0,span);
                } 
                var pathI = n.parentUrl.indexOf('path');                
                if (pathI != -1) {
                  var searchI = n.parentUrl.indexOf('search');
                  var packageI = n.parentUrl.indexOf('package');
                  var maxIndex = Math.max(searchI, packageI);
                  if (maxIndex == -1 || pathI > maxIndex)
                    n.url = n.parentUrl + '/' + nodeName;
                  else {
                    n.url = n.parentUrl.substring(0,maxIndex-1) +  '/' + nodeName + '&' + n.parentUrl.substring(maxIndex);
                  }
                }
          
                scope.selectedNode.id = node.id;
                scope.selectedNode.url = n.url;
                scope.selectedNode.path = n.a_attr.path;
                scope.selectedNode.text = n.text;
                if (typeof( n.url) != "undefined" && n.url != null) {                                       
                  $http({
                    url:  n.url, // /" + $scope.ware,
                    method: "GET"
                  }).success(function(data, status, headers, config) {
                    scope.selectedNode.content = angular.fromJson(data);
                    scope.selectedNode.show = true; 
                    scope.selectedNode.waiting = false;
                  }).error(function(data, status, headers, config) {
                  });
                }
                else {
                  scope.selectedNode.content = null;
                  scope.selectedNode.show = false;
                }       
                if (typeof( n.parentUrl) != "undefined" && n.parentUrl != null && n.parentUrl !== 'api') {  
                  scope.selectedNode.waiting = true;
                  scope.selectedNode.showAce = false;
                  scope.selectedNode.showFrame = false;           
                  
                  var span = n.parentUrl.indexOf(' - (');
                  if (span >0) {
                    n.parentUrl = n.parentUrl.substring(0,span);
                  }                     
                  $http({
                    url:  n.parentUrl, // /" + $scope.ware,
                    method: "GET"
                  }).success(function(data, status, headers, config) {
                    var parentContent = angular.fromJson(data);
                    scope.selectedNode.show = true; 
                    var span = n.text.indexOf(' - (');
                    var nodeName = n.text;
                    if (span >0) {
                      nodeName = nodeName.substring(0,span);
                    }
                    
                    for(var i = 0; i < parentContent.length; i++) {
                      if ((parentContent[i].text) === nodeName) {
                        scope.selectedNode.parentContent = parentContent[i];
                      }
                    }
                    if (scope.selectedNode.parentContent.overviewDescription != null && scope.selectedNode.parentContent.overviewDescription != 'undefined')  {
                      scope.title = scope.selectedNode.parentContent.text + " | " + " Blueprint";
                      scope.keywords = scope.selectedNode.parentContent.text+ ", blueprint, requirements";
                      scope.description = scope.selectedNode.parentContent.text + " - " +  String(scope.selectedNode.parentContent.overviewDescription).replace(/<[^>]+>/gm, '') ;
                      scope.$root.metaservice.set(scope.title,scope.description,scope.keywords);  
                    }
  
                    if (scope.selectedNode.parentContent != null) { // && scope.selectedNode.parentContent.resourceType=='file') {
                                            if (scope.selectedNode.parentContent.resourceType ==='file' ||
                        scope.selectedNode.parentContent.resourceType == 'project.energia') {
                                                if (scope.selectedNode.parentContent.link.substr(-2) === '.c'
                          || scope.selectedNode.parentContent.link.substr(-4) === '.cpp'
                          || scope.selectedNode.parentContent.link.substr(-4) === '.asm'
                          || scope.selectedNode.parentContent.link.substr(-4) === '.cmd'
                          || scope.selectedNode.parentContent.link.substr(-4) === '.ino'
                          || scope.selectedNode.parentContent.link.substr(-2) === '.h') {
                          scope.selectedNode.showAce = true;
                                                    scope.selectedNode.showFrame = false;
                                                    var link =  scope.selectedNode.parentContent.link;
                                                    $http({
                                                        url : link,
                                                        method : "GET"// ,
                                                    }).success(function(data, status, headers, config) {
                                                        scope.selectedNode.aceContent = data;
                                                        scope.selectedNode.waiting = false;
                          }).error(function(data, status, headers, config) {
                                                        scope.selectedNode.waiting = false;
                          });
                                                }
                        else {
                          scope.selectedNode.showAce = false;
                          scope.selectedNode.showFrame = true;
                          scope.selectedNode.show = false;                  
                          if (scope.selectedNode.parentContent.link.substr(-4) === '.txt' 
                            || scope.selectedNode.parentContent.link.substr(-4) === '.pdf'
                            || scope.selectedNode.parentContent.link.substr(-4) === '.htm'
                            || scope.selectedNode.parentContent.link.substr(-5) === '.html' ) {
                            var iframeSrc = scope.selectedNode.parentContent.link;
                            scope.selectedNode.weblink = $sce.trustAsResourceUrl(iframeSrc);
                          }
                          else {
                            scope.selectedNode.showFrame = false;
                          }
                          scope.selectedNode.show = true;
                          scope.selectedNode.waiting = false;
                        }                       
                                            }
                                            else if (scope.selectedNode.parentContent.resourceType ==='web.app' || scope.selectedNode.parentContent.resourceType ==='folder') {
                                                scope.selectedNode.showAce = false;
                                                scope.selectedNode.showFrame = true;
                                                var iframeSrc = scope.selectedNode.parentContent.link;
                                                scope.selectedNode.weblink = $sce.trustAsResourceUrl(iframeSrc);
                                                scope.selectedNode.waiting = false;
                                            }
                      else if (scope.selectedNode.parentContent.type ==='weblink') {
                        scope.selectedNode.showAce = false;
                        scope.selectedNode.showFrame = true;
                        var iframeSrc = scope.selectedNode.parentContent.link;
                        scope.selectedNode.weblink = $sce.trustAsResourceUrl(iframeSrc);
                        scope.selectedNode.waiting = false;
                        
                      }
                      else if (scope.selectedNode.parentContent.overviewLink != null) {
                        scope.selectedNode.showAce = false;
                        scope.selectedNode.showFrame = true;
                        var iframeSrc = scope.selectedNode.parentContent.overviewLink;
                        scope.selectedNode.weblink = $sce.trustAsResourceUrl(iframeSrc);
                        scope.selectedNode.waiting = false;
                      }
                      else {
                        scope.selectedNode.showAce = false;
                        scope.selectedNode.showFrame = false;
                        scope.selectedNode.waiting = false;
                      }
                    }
                  }).error(function(data, status, headers, config) {
                  });
                }
                else {
                  scope.selectedNode.parentContent = null;
                  scope.selectedNode.waiting = false;
              }
              }

              return url;
                        },
            /*
            "ajax" : {
              "url" : "_search_data.json",
              "data" : function (n) {
                return { id : n.attr ? n.attr("id") : 0 };
              }
            }, */
            'dataFilter' : function (data) {
              var j = angular.fromJson(data);
              scope.selectedNode.emptyTree = false;
              if (j.length == 0) {
                scope.selectedNode.emptyTree = true;
              }
              var uripath = $location.search();
              if ("link" in uripath) {
                var paths = uripath['link'].split("/");
              } else {
                var paths = [];
              }
              //get rid of "" entry
              if (paths[paths.length -1] == "") {
                paths.pop();
              }

              var resourceTitle = paths.pop();
              var parentTitle = paths[paths.length-1];
              var count = 0;
              for (var i=0; i<j.length; i++) {

                j[i].a_attr =  { 'title' : j[i].text } ;
                //preceding directories...
                if (typeof j[i].state !== "undefined") {
                  if ($.inArray(j[i].a_attr.title,paths) > -1) {
                    if (j[i].state.opened) {

                      //already open  
                    } else {
                      //in array, so open
                      j[i].state.opened = true;
                    }
                  } 
                } 


                
                if (j[i].icon != null) {
                  j[i].icon = 'content/'+(j[i].icon).replace(/\\/g,"/");
                }

                if (j[i].text === 'Devices') {
                  j[i].type = 'devices';
                }
                else if (j[i].text === 'Libraries') {
                  j[i].type = 'libraries';
                } 
                else if (j[i].text === 'Energia') {
                  j[i].type = 'ino';
                }               
                else if (j[i].text === 'Development Tools') {
                  j[i].type = 'kits';
                }               
                else if (j[i].type === 'weblink') {
                  j[i].type = 'link';
                  if ((j[i].link).lastIndexOf('.pdf') > 0) {
                    j[i].type = 'pdf';
                  }
                }
                else if (j[i].resourceType === 'file' || j[i].resourceType === 'project.energia') {
                  j[i].type = 'file';
                  if ((j[i].link).lastIndexOf('.pdf') > 0) {
                    j[i].type = 'pdf';
                  }
                  else if ((j[i].link).lastIndexOf('.cmd') > 0) {
                    j[i].type = 'cmd';
                  }
                  else if ((j[i].link).lastIndexOf('.zip') > 0) {
                    j[i].type = 'zip';
                  }
                  else if ((j[i].link).lastIndexOf('.ino') > 0) {
                    j[i].type = 'c';
                  }
                  else if (j[i].link.substr(-2) === '.c' || j[i].link.substr(-4) === '.cpp') {
                    j[i].type = 'c';
                    //j[i].a_attr = { 'title' : 'A C file that can be imported to Code Composer Studio cloud' };
                  }
                  else if ((j[i].link).lastIndexOf('.asm') > 0) {
                    j[i].type = 'asm';
                  }
                  else if (j[i].link.substr(-2) === '.h') {
                    j[i].type = 'h';
                  }
                  else if (j[i].link.substr(-4) === '.htm' || j[i].link.substr(-5) === '.html') {
                    j[i].type = 'link';
                  }
                }
                else if (j[i].resourceType === 'folder') {
                  j[i].type = 'folder';
                }
                                else if (j[i].resourceType === 'file.executable') {
                                    j[i].type = 'exec';
                  j[i].a_attr = { 'title' : j[i].text+' : A desktop application example that can be downloaded to your PC to run' } ;
                                }
                                else if (j[i].resourceType === 'web.app') {
                                    j[i].type = 'app';
                  j[i].a_attr = { 'title' : j[i].text+' : A web based application that you can run directly in Resource Explorer' };
                                }
                                else if (j[i].resourceType === 'projectSpec' || j[i].resourceType === 'project.ccs' || j[i].resourceType === 'folder.importable') {
                  j[i].type = 'ccs';
                  j[i].a_attr = { 'title' : j[i].text+' : A C/C++ Project for Code Composer Studio' };
                }
                else if (j[i].resourceType === 'project.energia') {
                  j[i].type = 'ino';
                  j[i].a_attr = { 'title' : j[i].text+' : Energia Sketch' };
                }

                /*
                else if (j[i].numChildren > 0) {
                  j[i].type = 'group';
                }
                */

                if (j[i].numChildren != null && j[i].numChildren !== 0) {
                  if (parentTitle === j[i].text) {
                      //show the number for the children, however we don't change that they are returned from the server
                      //they will be hidden by the filter below (removed from the server response)
                      j[i].text = j[i].text+' - ('+j[i].numChildren+')';
                  } else {
                    if (j[i].text === 'C' || j[i].text === 'Assembly') { // || j[i].text === 'Energia') {
                      //don't show these files
                      j[i].children = false;
                      j[i].text = j[i].text+' - ('+j[i].numChildren+')';
                      j[i].numChildren = 0;
                    }               
                    else {
                      //its okay to show these files
                      j[i].text = j[i].text+' - ('+j[i].numChildren+')';
                    }
                        
                  }
                }

                // some magic to automatically open links, more in select_node event binding
                // remove files from the response except the one that we need
                // check for package parameter in response, need to account for this to filter them out properly
                // hacky.....

                var returned_url = j[i].url;
                var pathI = j[i].url.indexOf('path'); 
              
                if (pathI != -1) {
                  var packageI = j[i].url.indexOf('package');
                  var searchI = j[i].url.indexOf('search');
                  var minIndex = Math.min(packageI, searchI);
                  var maxIndex = Math.max(packageI, searchI);

                  // no package or search, or they are both before path 
                  if ((minIndex == -1 && maxIndex == -1) || (minIndex < pathI && maxIndex < pathI)) {       
                    returned_url = j[i].url.substring(pathI+5);
                  // path is between package and search 
                  } else if (pathI > minIndex && pathI < maxIndex) {  
                    returned_url = j[i].url.substring(pathI+5,maxIndex-1);
                  // path before max Index, but the other parameter isn't there
                  } else if (minIndex == -1 && maxIndex != -1) { 
                    returned_url = j[i].url.substring(pathI+5,maxIndex-1);
                  } else {
                    //both search and package are ahead of path
                    returned_url = j[i].url.substring(pathI+5,minIndex-1);
                  }               }
                // if (j[i].url.indexOf("&") > -1) {
                //   = j[i].url.substring(0,j[i].url.indexOf("&"));
                // } else {
                //  var returned_url = j[i].url
                // }

                returned_url = returned_url.split("/");
              
                if (returned_url[returned_url.length-1] == "C" || returned_url[returned_url.length -1] == "Assembly") {
                  var res_text = j[i].text
                  if (res_text != resourceTitle) {
                    j.splice(i,1);
                    i--;
                    if (j.length == 1) break;
                  }
                }

              }
              return angular.toJson(j);
            }
                    }
                },      
            "search" : { 
          'search_callback': function(str, nodes) {
            var f = new $.vakata.search(str, true, { 
                  caseSensitive : false, 
                  fuzzy : false 
                }
              );
            if (f.search(nodes.text).isMatch) return true;

            //console.log(nodes);
            
            if (!nodes.original) return false;
            
            /* search description field */
            if (typeof(nodes.original.description) != "undefined") {
              if (f.search(nodes.original.description).isMatch) return true;
            }
            
            /* search tags array*/
            if (typeof(nodes.original.tags) != "undefined" && nodes.original.tags.length > 0) {
              for (i=0; i< nodes.original.tags.length; i++) {
                if (f.search(nodes.original.tags[i]).isMatch) return true;
              }
            }
            return false;
          },
          'fuzzy' : false /*,
          'show_only_matches' : true*/
        },     
            "types" : {
              "folder" : {
                "icon" : "icns/folder.gif"
              },
          "file" : {
            "icon" : "icns/file.gif"
          },
          "resource" : {
                "icon" : "icns/file.gif"
              },
          "zip" : {
            "icon" : "icns/zip.png"
          },
          "devices" : {
            "icon" : "icns/devices.png"
          },
          "libraries" : {
            "icon" : "icns/libraries.png"
          },
          "kits" : {
            "icon" : "icns/kits.png"
          },          
          "link" : {
            "icon" : "icns/link.png"
          },
          "group" : {
            "icon" : "icns/group.png"
          },
          "cmd": {
            "icon" : "icns/linker_command_file.gif"
          },
          "ino": {
            "icon" : "icns/new_sketch.gif"
          },
          "c" : {
            "icon" : "icns/c_file_obj.gif"
          },
          "h" : {
            "icon" : "icns/h_file_obj.gif"
          },
          "ccs" : {
            "icon" : "icns/ccs_proj.gif"
          },          
          "asm" : {
            "icon" : "icns/s_file_obj.gif"
          },          
              "pdf" : {
                "icon" : "icns/pdf.png"
              },
                    "exec" : {
                        "icon" : "icns/exec.gif"
                    },
                    "app" : {
                        "icon" : "icns/demo.png"
                    }
                },
            "plugins" : ["types","search", "wholerow"]
          });            
            tree.bind('open_node.jstree', function(event, data) {
        if (typeof(scrollingContent) != "undefined" && scrollingContent != null) {
          scrollingContent.jScrollPane( { autoReinitialise: true })
          .parent(".jScrollPaneContainer").css({
            width:  '100%'
          , height: '100%'
          });
        }         
        if (typeof(scrollingContent2) != "undefined" && scrollingContent2 != null) {
          scrollingContent2.jScrollPane( { autoReinitialise: true })
          .parent(".jScrollPaneContainer").css({
            width:  '100%'
          , height: '100%'
          });
        }     
      });
            tree.bind('close_node.jstree', function(event, data) {
        if (typeof(scrollingContent) != "undefined" && scrollingContent != null) {
          scrollingContent.jScrollPane( { autoReinitialise: true })
          .parent(".jScrollPaneContainer").css({
            width:  '100%'
          , height: '100%'
          });
        }         
        if (typeof(scrollingContent2) != "undefined" && scrollingContent2 != null) {
          scrollingContent2.jScrollPane( { autoReinitialise: true })
          .parent(".jScrollPaneContainer").css({
            width:  '100%'
          , height: '100%'
          });
        }     
      });     
  
          tree.bind('after_open.jstree', function(event,data) {
    //        console.log("here");
          var uripath = $location.search();
        if ("link" in uripath) {
          var paths = uripath['link'].split("/");
          //get rid of "" entry at end of array
          //caused by split with "/" at end of URI
          if (paths[paths.length -1] == "") {
            paths.pop();
          }
          var resourceTitle = paths.pop();
          var parentNode = paths.pop();

          var node_text_index = data.node.text.indexOf("- (");
          var node_title = "";
          if (node_text_index > -1) {
            node_title = data.node.text.substring(0,node_text_index).trim();
          } else {
            node_title = data.node.text;
          }


          if (node_title == parentNode) {
            var parentDOM = $('#'+data.node.id);
            // The title of an element and the text can be different
            // while we should pass the title that the element is given to the URL, it becomes problematic
            // because all example projects will have the title "A C/C++ Project for Code Composer Studio"
            // creating much longer url in most cases, so instead we pass the text returned from the server
            // However, selecting the node based on the text for "C" folders, is very impossible
            // because its one letter 
            if (resourceTitle == "C") { 
              var wantedResource = $("a[title='"+resourceTitle+"']");
            } else {
              var wantedResource = $("a:contains('"+resourceTitle+"')");
            }
            if (wantedResource.length > 1) {
              //wantedResource = wantedResource[wantedResource.length-1];
              for (i in wantedResource) {
                if ($.contains(parentDOM,wantedResource)) {
                  wantedResource = wantedResource[i];
                  break;
                }
               }
            }

            var tree_id = $(wantedResource).attr("id");

            if (typeof tree_id !== "undefined") {
              var actual_id = tree_id.replace("_anchor", "");
              if ($.inArray(actual_id,data.node.children) > -1) {
                data.instance.select_node("#"+tree_id); 
              }
            }
          }
        }
        

          });  
      tree.bind('select_node.jstree',function(event,data) {
        var pathIndex = data.node.original.url.indexOf("path=");
        var node_title = (typeof(data.node.original.name) !== "undefined") ? data.node.original.name:data.node.a_attr.title;
        var nodelink = "";
        if (pathIndex > -1) {
          nodelink = data.node.original.url.substring(pathIndex+5);
          var packageIndex = nodelink.indexOf("&");
          if ( packageIndex > -1) {
            nodelink = "?link="+nodelink.substring(0,packageIndex) + "/" + node_title
          } else {
            nodelink = "?link="+nodelink + "/"+ node_title; 
          }
        } else {
          nodelink = "?link="+node_title; 
        }

        //this is a super hacky way to do this, not entirely sure how to not do it this way however
        if (data.node.type == "asm" || data.node.type == "c" ) {
          //better yet hide, do not remove nodes unless their parent is C or Assembly
          // e.g. Energia files, or "Empty" Projects with a single C file in them
          
          if (data.instance.get_node(data.node.parent).text.indexOf("Assembly - (") > -1
              || data.instance.get_node(data.node.parent).text.indexOf("C - (") > -1 ) {
              if ($location.url().indexOf(node_title) != -1) {
                data.instance.delete_node(data.node.id);
              } 
          }

        }       

        if ($location.path().indexOf(nodelink) == -1) {

          if ($location.path().indexOf("/link") > -1) {
            $location.url($location.path() + nodelink);
          }else {
            //var link = ($location.path()[$location.path().length -1] == "/")?"link":"/link";
            //$location.url($location.path()+link+nodelink);
            $location.url($location.path()+nodelink);
          }
        }

      });
            tree.bind('select_node.jstree', function(event, data) {

          $timeout(function() {
        if (typeof(scrollingContent) != "undefined" && scrollingContent != null) {
          scrollingContent.jScrollPane( { autoReinitialise: true })
          .parent(".jScrollPaneContainer").css({
            width:  '100%'
          , height: '100%'
          });
        }     
        if (typeof(scrollingContent2) != "undefined" && scrollingContent2 != null) {
          scrollingContent2.jScrollPane( { autoReinitialise: true })
          .parent(".jScrollPaneContainer").css({
            width:  '100%'
          , height: '100%'
          });
        }     
          },500);

        scope.selectedNode.waiting = true;
        var id = data.node.id;
        /* 
        if (id != undefined) {
          if ($("li[id=" + id + "]").hasClass("jstree-open"))
            treeElement.jstree("close_node", "#" + id);
          else
            treeElement.jstree("open_node", "#" + id);
        }
        */
              
                var n =  data.node;       
        n.parentUrl = data.node.original.url;
        if (n.parentUrl.substring(0,1) === '/') {
          n.parentUrl = n.parentUrl.substring(1); 
        }
        
        var nodeName = data.node.text;
        var span = nodeName.indexOf(' - (');
        if (span > 0) {
          nodeName = nodeName.substring(0,span);
        }
        var pathI = n.parentUrl.indexOf('path');  
              
        if (pathI != -1) {
          var packageI = n.parentUrl.indexOf('package');
          var searchI = n.parentUrl.indexOf('search');
          var minIndex = Math.min(packageI, searchI);
          var maxIndex = Math.max(packageI, searchI);

          // no package or search, or they are both before path 
          if ((minIndex == -1 && maxIndex == -1) || (minIndex < pathI && maxIndex < pathI)) {       
            n.url = n.parentUrl + '/' + nodeName;
          // path is between package and search 
          } else if (pathI > minIndex && pathI < maxIndex) {  
            n.url = n.parentUrl.substring(0,maxIndex-1) + '/' + nodeName + '&' + n.parentUrl.substring(maxIndex);
          // path before max Index, but the other parameter isn't there
          } else if (minIndex == -1 && maxIndex != -1) { 
            n.url = n.parentUrl.substring(0,maxIndex-1) +  '/' + nodeName + '&' + n.parentUrl.substring(maxIndex);
          } else {
            //both search and package are ahead of path
            n.url = n.parentUrl.substring(0,minIndex-1) +  '/' + nodeName + '&' + n.parentUrl.substring(minIndex);
          }

        }
        else {
          if (n.parentUrl.indexOf('?') == -1)
            n.url = n.parentUrl + '?path=' + nodeName;
          else
            n.url = n.parentUrl + '&path=' + nodeName;
        }


        scope.selectedNode.id = n.id;
        scope.selectedNode.url = n.url;
        scope.selectedNode.path = n.a_attr.path;
        scope.selectedNode.text = n.text;

        
        if (typeof( n.url) != "undefined" && n.url != null) {                                 
          $http({
            url:  n.url, // /" + $scope.ware,
            method: "GET"
          }).success(function(data, status, headers, config) {
            scope.selectedNode.content = angular.fromJson(data);
            scope.selectedNode.show = true; 
            scope.selectedNode.waiting = false;
            nodeSelectionChanged(scope.selectedNode);
          }).error(function(data, status, headers, config) {
          });
        }
        else {
          scope.selectedNode.content = null;
          scope.selectedNode.show = false;
        }     
        if (typeof( n.parentUrl) != "undefined" && n.parentUrl != null && n.parentUrl !== 'api') {   
          scope.selectedNode.waiting = true;
          scope.selectedNode.showAce = false;
          scope.selectedNode.showFrame = false; 
                    scope.selectedNode.weblink = $sce.trustAsResourceUrl('about:blank');
          var span = n.parentUrl.indexOf(' - (');
          if (span >0) {
            n.parentUrl = n.parentUrl.substring(0,span);
          }                     
          $http({
            url:  n.parentUrl, // /" + $scope.ware,
            method: "GET"
          }).success(function(data, status, headers, config) {
            var parentContent = angular.fromJson(data);
            scope.selectedNode.show = true; 
            var span = n.text.indexOf(' - (');
            var nodeName = n.text;
            if (span >0) {
              nodeName = nodeName.substring(0,span);
            }
            
            for(var i = 0; i < parentContent.length; i++) {
              if ((parentContent[i].text) === nodeName) {
                scope.selectedNode.parentContent = parentContent[i];
              }
            }
            if (scope.selectedNode.parentContent != null) { // && scope.selectedNode.parentContent.resourceType=='file') {
              scope.title = "Blueprint";
              scope.keywords = "Blueprint, requirements";
              scope.description = "Our requirements management software helps to de-risk and accelerate enterprise projects so that they are completed on time, and on budget.";
              if (scope.selectedNode.parentContent.text != undefined) {
                scope.title = scope.selectedNode.parentContent.text + " | " + "Blueprint";
              }
              if (scope.selectedNode.parentContent.description != undefined) {
                scope.description = scope.selectedNode.parentContent.description;
              }
              if (scope.selectedNode.parentContent.tags != undefined) {
                scope.keywords = scope.selectedNode.parentContent.tags + ", blueprint, requirements";
              }
              scope.$root.metaservice.set(scope.title,scope.description,scope.keywords);  
              if (scope.selectedNode.parentContent.resourceType ==='file' ||
                scope.selectedNode.parentContent.resourceType == 'project.energia') {
                if (scope.selectedNode.parentContent.link.substr(-2) === '.c'
                  || scope.selectedNode.parentContent.link.substr(-4) === '.cpp'
                  || scope.selectedNode.parentContent.link.substr(-4) === '.asm'
                  || scope.selectedNode.parentContent.link.substr(-4) === '.cmd'
                  || scope.selectedNode.parentContent.link.substr(-4) === '.ino'
                  || scope.selectedNode.parentContent.link.substr(-2) === '.h') {
                  scope.selectedNode.showAce = true;
                  scope.selectedNode.showFrame = false;               
                  var link =  scope.selectedNode.parentContent.link;
                  $http({
                    url : link,
                    method : "GET"// ,
                  }).success(function(data, status, headers, config) {
                    scope.selectedNode.aceContent = data;
                    scope.selectedNode.waiting = false;
                  }).error(function(data, status, headers, config) {
                                        scope.selectedNode.waiting = false;
                  });                 
                }
                else {
                  scope.selectedNode.showAce = false;
                  scope.selectedNode.showFrame = true;
                  scope.selectedNode.show = false;                  
                  if (scope.selectedNode.parentContent.link.substr(-4) === '.txt'
                    || scope.selectedNode.parentContent.link.substr(-4) === '.pdf'
                    || scope.selectedNode.parentContent.link.substr(-4) === '.htm'
                    || scope.selectedNode.parentContent.link.substr(-5) === '.html' ) {
                    var iframeSrc = scope.selectedNode.parentContent.link;
                    scope.selectedNode.weblink = $sce.trustAsResourceUrl(iframeSrc);
                  }
                  else {
                    scope.selectedNode.showFrame = false;
                  }
                  scope.selectedNode.show = true;
                  scope.selectedNode.waiting = false;
                }
              }
                            else if (scope.selectedNode.parentContent.resourceType ==='web.app' || scope.selectedNode.parentContent.resourceType ==='folder') {
                                scope.selectedNode.showAce = false;
                                scope.selectedNode.showFrame = true;
                                var iframeSrc = scope.selectedNode.parentContent.link;
                                scope.selectedNode.weblink = $sce.trustAsResourceUrl(iframeSrc);
                                scope.selectedNode.waiting = false;
                            }
              else if (scope.selectedNode.parentContent.type ==='weblink') {
                                // <<< open weblinks in new tab/window until we solve the https issue, OPS, 10/9/2014
                /*
                                scope.selectedNode.showAce = false;
                                scope.selectedNode.showFrame = false;
                                scope.selectedNode.waiting = false;
                                openLinkInTab(scope.selectedNode.parentContent.link);
                */
                                
                                scope.selectedNode.showAce = false;
                scope.selectedNode.showFrame = true;              
                var iframeSrc = scope.selectedNode.parentContent.link;
                //if (iframeSrc.indexOf('www-s') > 0)
                //  iframeSrc = 'api/resolve?source='+iframeSrc;
                //else if ($location.absUrl().indexOf('https') > -1)
                //  iframeSrc = iframeSrc.replace('http', 'https');
                scope.selectedNode.weblink = $sce.trustAsResourceUrl(iframeSrc);
                scope.selectedNode.waiting = false;
                
                                // >>>
              }
              else if (scope.selectedNode.parentContent.overviewLink != null) {
                                scope.selectedNode.showAce = false;
                scope.selectedNode.showFrame = true;              
                var iframeSrc = scope.selectedNode.parentContent.overviewLink;
                //if (iframeSrc.indexOf('www-s') > 0)
                //  iframeSrc = 'api/resolve?source='+iframeSrc;
                //else if ($location.absUrl().indexOf('https') > -1)
                //  iframeSrc = iframeSrc.replace('http', 'https');

                iframeSrc = 'content/' + iframeSrc;

                scope.selectedNode.weblink = $sce.trustAsResourceUrl(iframeSrc);
                scope.selectedNode.waiting = false;               
              }
                            else {
                                scope.selectedNode.showAce = false;
                                scope.selectedNode.showFrame = false;
                                scope.selectedNode.waiting = false;
                            }
            }
            nodeSelectionChanged(scope.selectedNode);
          }).error(function(data, status, headers, config) {
          });
        }
        else {
          scope.selectedNode.parentContent = null;
          scope.selectedNode.waiting = false;
        }
        if(scope.selectionChanged) 
          $timeout(function() {
          scope.selectionChanged(scope.selectedNode);
          });
                    
        if (typeof(scrollingContent) != "undefined" && scrollingContent != null) {
          scrollingContent.jScrollPane( { autoReinitialise: true })
          .parent(".jScrollPaneContainer").css({
            width:  '100%'
          , height: '100%'
          });
        }     
        if (typeof(scrollingContent2) != "undefined" && scrollingContent2 != null) {
          scrollingContent2.jScrollPane( { autoReinitialise: true })
          .parent(".jScrollPaneContainer").css({
            width:  '100%'
          , height: '100%'
          });
        }     

        nodeSelectionChanged(scope.selectedNode);
              });
              function expandAndSelect(ids) {
                ids = ids.slice()
                var expandIds = function() {
                  if(ids.length == 1) {
                    treeElement.jstree('deselect_node', treeElement.jstree('get_selected'));
                    treeElement.jstree('select_node', ids[0]);
                  }
                  else
                    treeElement.jstree('open_node', ids[0], function() {
                      ids.splice(0, 1);
                      expandIds();
                    });
                };
                expandIds();
              }      
              scope.$watch('selectedNode.id', function() {
                var selectedIds = treeElement.jstree('get_selected');
                if((selectedIds.length == 0 && scope.selectedNode.id) 
                 || selectedIds.length != 1 || selectedIds[0] != scope.selectedNode.id) {
                  if(selectedIds.length != 0)
                    treeElement.jstree('deselect_node', treeElement.jstree('get_selected'));
                  if(scope.selectedNode.id){
                    if(scope.selectedNode.showWelcome){
                      for (var i = 0; i < rootNodes.length; i++) {
                        if (rootNodes[i].text != undefined && rootNodes[i].text.indexOf(scope.selectedNode.id) != -1){
                          scope.selectedNode.id = rootNodes[i].id;
                          break;
                        }
                      }
                    }
                    treeElement.jstree('select_node', scope.selectedNode.id);
                  }
                }
                //nodeSelectionChanged(scope.selectedNode);
              });
              scope.$watch('selectedNode.path', function() {
                if(scope.pathToIdsUrl) {         
                  var selected = treeElement.jstree('get_selected', true);
                  var prevPath = selected.length ? selected[0].a_attr.path : null;
                  var newPath = scope.selectedNode.path
                  if(selected.length != 1 || prevPath != newPath) {
                    if(newPath)
                      $http.get(scope.pathToIdsUrl, { params: { path: newPath }}).then(function(data) {
                        expandAndSelect(data.data);

                      });
                    else
                      scope.selectedNode.id = null
                  }
                }
              });      
            //nodeSelectionChanged(scope.selectedTreeNode);
        }
    };
});


</script>
</body>
</html>